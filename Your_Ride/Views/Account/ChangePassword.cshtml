@model Your_Ride.ViewModels.Account.ChangePasswordViewModel

@{
    ViewData["Title"] = "Change Password";
}

<h2>Change Password</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}

<form asp-action="ChangePassword" method="post" id="changePasswordForm">
    @Html.AntiForgeryToken()
    <div class="mb-3">
        <label asp-for="OldPassword" class="form-label">Old Password</label>
        <input asp-for="OldPassword" class="form-control" id="oldPasswordInput" />
        <span asp-validation-for="OldPassword" class="text-danger"></span>
        <div id="oldPasswordError" class="text-danger"></div>
    </div>

    <div class="mb-3">
        <label asp-for="NewPassword" class="form-label">New Password</label>
        <input asp-for="NewPassword" class="form-control" />
        <span asp-validation-for="NewPassword" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="ConfirmPassword" class="form-label">Confirm Password</label>
        <input asp-for="ConfirmPassword" class="form-control" />
        <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-primary">Change Password</button>
@*     <a asp-action="Profile" class="btn btn-secondary">Back to Profile</a>
 *@</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
                $(document).ready(function () {
            $("#oldPasswordInput").on("keyup", function () {
                var oldPassword = $(this).val();

                if (oldPassword.trim() === "") {
                    $("#oldPasswordError").text("Old password is required.");
                    return;
                }

                // Prepare the full model to send to the server
                var model = {
                    OldPassword: oldPassword
                };

                // Make an AJAX POST request
                $.ajax({
                    url: '@Url.Action("CheckOldPassword", "Account")',
                    type: 'POST',
                    data: JSON.stringify(model),  // Send the full model
                    contentType: "application/json",  // Set the content type to JSON
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() // Include CSRF token
                    },
                    success: function (response) {
                        console.log("Response from server: ", response); // Log the response from the server
                        if (!response.success) {
                            $("#oldPasswordError").text("Old password is incorrect.");
                        } else {
                            $("#oldPasswordError").text("");  // Clear error if password is correct
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("AJAX error: ", status, error); // Log the error if any occurs
                        $("#oldPasswordError").text("An error occurred while verifying the password.");
                    }
                });
            });

            // Prevent form submission if there's an error with the old password
            $("#changePasswordForm").on("submit", function (e) {
                if ($("#oldPasswordError").text() !== "") {
                    e.preventDefault();
                }
            });
        });

    </script>
}
