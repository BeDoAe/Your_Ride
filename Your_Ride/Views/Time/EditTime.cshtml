@model Your_Ride.ViewModels.TimeViewModel.IFormFileTimeVM
@using Your_Ride.ViewModels.AppointmentviewModel;
@using Your_Ride.ViewModels.BusViewModel;
@{
    ViewData["Title"] = "Edit Time";
    var buses = ViewBag.Buses as List<BusVM>;
    var appointments = ViewBag.Appointments as List<AppointmentVM>;
    var busGuides = ViewBag.BusGuides as List<ApplicationUser>;
}

<h2>Edit Time</h2>

<form asp-action="EditTime" method="post" enctype="multipart/form-data">
    <input type="hidden" asp-for="Id" />

    <div class="form-group">
        <label asp-for="TimeOnly" class="control-label">Time</label>
        <input asp-for="TimeOnly" class="form-control" type="time" />
        <span asp-validation-for="TimeOnly" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Fee" class="control-label">Fee</label>
        <input asp-for="Fee" class="form-control" type="number" step="0.01" />
        <span asp-validation-for="Fee" class="text-danger"></span>
    </div>
  
    <div class="form-group mb-3">
        <label asp-for="Category" class="control-label">Trip Category</label>
        <select asp-for="Category" class="form-select" id="categorySelect" onchange="toggleDateFields()">
            <option value="0">Arrival</option>
            <option value="1">Departure</option>
        </select>
    </div>
    <div id="arrivalDateField" class="mb-3">
        <label class="form-label">Arrival Due Date (Optional):</label>
        <input asp-for="DueDateArrivalSubmission" class="form-control" type="date" placeholder="Not required" />
    </div>

    <div id="departureDateField" class="mb-3" style="display:none;">
        <label class="form-label">Departure Due Date (Optional):</label>
        <input asp-for="DueDateDepartureSubmission" class="form-control" type="date" placeholder="Not required" />
    </div>
    <div class="form-group">
        <label asp-for="BusID" class="control-label">Bus</label>
        <select asp-for="BusID" class="form-control">
            @foreach (var bus in buses)
            {
                <option value="@bus.Id">@bus.BusIdentifier</option>
            }
        </select>
        <span asp-validation-for="BusID" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="BusGuideId" class="control-label">Bus Guide</label>
        <select asp-for="BusGuideId" class="form-control">
            @foreach (var guide in busGuides)
            {
                <option value="@guide.Id">@guide.UserName</option>
            }
        </select>
        <span asp-validation-for="BusGuideId" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="AppointmentId" class="control-label">Appointment</label>
        <select asp-for="AppointmentId" class="form-control">
            @foreach (var appointment in appointments)
            {
                <option value="@appointment.Id">@appointment.Date</option>
            }
        </select>
        <span asp-validation-for="AppointmentId" class="text-danger"></span>
    </div>

    <h3>Locations</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Location</th>
                <th>Image</th>
                <th>Order</th>
                <th>URL</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="locations-container">
            @for (int i = 0; i < Model.FormFileLocationsWithPics.Count; i++)
            {
                <tr>
                    <td>
                        <input type="text" asp-for="FormFileLocationsWithPics[i].Location" class="form-control" />
                        <input type="text" asp-for="FormFileLocationsWithPics[i].PathURL" class="form-control" placeholder="Not Required" />
                        <input type="hidden" asp-for="FormFileLocationsWithPics[i].Id" />
                        <input type="hidden" asp-for="FormFileLocationsWithPics[i].TimeId" />
                    </td>
                    <td>
                        @if (!string.IsNullOrEmpty(Model.FormFileLocationsWithPics[i].ImagePath))
                        {
                            <img src="@Model.FormFileLocationsWithPics[i].ImagePath" width="100" height="100" />
                        }
                        <input type="file" asp-for="FormFileLocationsWithPics[i].ImageFile" class="form-control" />
                    </td>
                    <td>
                        <input type="number" asp-for="FormFileLocationsWithPics[i].LocationOrder" class="form-control" />
                    </td>
                    <td>
                        <a href="@Url.Action("DeleteLocationImage", "Time", new { id = Model.FormFileLocationsWithPics[i].Id })" class="btn btn-danger">Delete</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <button type="button" class="btn btn-primary" onclick="addLocation()">Add Location</button>

    <div class="form-group mt-3">
        <button type="submit" class="btn btn-success">Save Changes</button>
        <a asp-action="GetAllTimes" class="btn btn-secondary">Cancel</a>
    </div>
</form>

@section Scripts {
    <script>
            function toggleDateFields() {
            var category = document.getElementById("categorySelect").value;
            document.getElementById("arrivalDateField").style.display = (category == "0") ? "block" : "none";
            document.getElementById("departureDateField").style.display = (category == "1") ? "block" : "none";
        }
        function addLocation() {
            var container = document.getElementById("locations-container");
            var index = container.children.length;
            var row = document.createElement("tr");

            row.innerHTML = `
                <td>
                    <input type="text" name="FormFileLocationsWithPics[${index}].Location" class="form-control" required />
                    <input type="text" asp-for="FormFileLocationsWithPics[i].PathURL" class="form-control" placeholder="Not Required" />
                    <input type="hidden" name="FormFileLocationsWithPics[${index}].TimeId" value="@Model.Id" />
                </td>
                <td>
                    <input type="file" name="FormFileLocationsWithPics[${index}].ImageFile" class="form-control" required />
                </td>
                <td>
                    <input type="number" name="FormFileLocationsWithPics[${index}].LocationOrder" class="form-control" required />
                </td>
                <td>
                    <button type="button" class="btn btn-danger" onclick="removeRow(this)">Remove</button>
                </td>
            `;

            container.appendChild(row);
        }

        function removeRow(button) {
            button.closest("tr").remove();
        }
    </script>
}
